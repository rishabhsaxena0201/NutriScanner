<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NutriScanner</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    #output {
      margin-top: 20px;
      white-space: pre-wrap;
    }
    #image-preview {
      margin-top: 10px;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h2>NutriScanner</h2>

  <input type="file" accept="image/*" capture="environment" id="cameraInput" style="display: none;" />
  <button onclick="document.getElementById('cameraInput').click()">Start Camera</button>

  <img id="image-preview" />
  <div id="output">Awaiting image...</div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
  <script>
    const input = document.getElementById('cameraInput');
    const output = document.getElementById('output');
    const imgPreview = document.getElementById('image-preview');

    input.addEventListener('change', async () => {
      const file = input.files[0];
      if (!file) return;

      output.textContent = 'Scanning image...';
      imgPreview.src = URL.createObjectURL(file);

      const { data: { text } } = await Tesseract.recognize(file, 'eng');
      output.textContent = 'Extracted text:\n' + text;

      // Basic nutrition extraction
      const nutrition = {
        energy: parseFloat((/energy.*?(\d+)\s?k?cal/i.exec(text) || [])[1]) || 0,
        sugar: parseFloat((/sugars?.*?(\d+(\.\d+)?)/i.exec(text) || [])[1]) || 0,
        fat: parseFloat((/saturated.*?(\d+(\.\d+)?)/i.exec(text) || [])[1]) || 0,
        sodium: parseFloat((/sodium.*?(\d+(\.\d+)?)/i.exec(text) || [])[1]) || 0,
        fiber: parseFloat((/fiber.*?(\d+(\.\d+)?)/i.exec(text) || [])[1]) || 0,
        protein: parseFloat((/protein.*?(\d+(\.\d+)?)/i.exec(text) || [])[1]) || 0,
        fruits: parseFloat((/fruit.*?(\d+)%?/i.exec(text) || [])[1]) || 0,
      };

      const scoreBreakdown = calculateNutriScore(nutrition);
      output.textContent += '\n\nNutri-Score: ' + scoreBreakdown.score;
      output.textContent += '\n\nBreakdown:\n' + JSON.stringify(scoreBreakdown.details, null, 2);
    });

    function calculateNutriScore(n) {
      // Negative points
      const energyPoints = Math.min(Math.floor(n.energy / 335), 10); // Roughly kJ
      const sugarPoints = Math.min(Math.floor(n.sugar), 10);
      const fatPoints = Math.min(Math.floor(n.fat), 10);
      const sodiumPoints = Math.min(Math.floor(n.sodium / 90), 10);

      // Positive points
      const fiberPoints = Math.min(Math.floor(n.fiber), 5);
      const proteinPoints = Math.min(Math.floor(n.protein), 5);
      const fruitPoints = n.fruits >= 80 ? 5 : n.fruits >= 60 ? 2 : n.fruits >= 40 ? 1 : 0;

      const negative = energyPoints + sugarPoints + fatPoints + sodiumPoints;
      const positive = fiberPoints + proteinPoints + fruitPoints;

      let score = negative - positive;

      let grade = 'E';
      if (score <= -1) grade = 'A';
      else if (score <= 2) grade = 'B';
      else if (score <= 10) grade = 'C';
      else if (score <= 18) grade = 'D';

      return {
        score: grade,
        details: {
          energyPoints,
          sugarPoints,
          fatPoints,
          sodiumPoints,
          fiberPoints,
          proteinPoints,
          fruitPoints,
          finalScore: score
        }
      };
    }
  </script>
</body>
</html>
