<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NutriScanner</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .output {
      margin-top: 20px;
      white-space: pre-wrap;
      background: #f4f4f4;
      padding: 10px;
      border-radius: 8px;
    }
    button {
      margin: 5px;
    }
  </style>
</head>
<body>
  <h2>NutriScanner</h2>
  <input type="file" accept="image/*" id="upload" />
  <div class="output" id="output">Upload an image of nutrition info table.</div>

  <script>
    async function extractTextFromImage(file) {
      const worker = await Tesseract.createWorker('eng');
      const { data } = await worker.recognize(file);
      await worker.terminate();
      return data.text;
    }

    function parseNutritionText(text) {
      const lines = text.toLowerCase().split("\n").map(l => l.trim());
      const nutrition = {
        energy: null,
        sugar: null,
        satFat: null,
        sodium: null,
        fiber: null,
        protein: null,
        fvlPercent: null
      };

      for (const line of lines) {
        if (line.includes("energy") && !nutrition.energy) {
          const match = line.match(/energy.*?(\d+)\s*k?j/i);
          if (match) nutrition.energy = parseInt(match[1]);
        }
        if ((line.includes("sugar") || line.includes("sugars")) && !nutrition.sugar) {
          const match = line.match(/(\d+(\.\d+)?)/);
          if (match) nutrition.sugar = parseFloat(match[1]);
        }
        if (line.includes("satur") && !nutrition.satFat) {
          const match = line.match(/(\d+(\.\d+)?)/);
          if (match) nutrition.satFat = parseFloat(match[1]);
        }
        if (line.includes("sodium") || line.includes("salt")) {
          const match = line.match(/(\d+(\.\d+)?)/);
          if (match) nutrition.sodium = parseFloat(match[1]) * (line.includes("salt") ? 400 : 1);
        }
        if (line.includes("fiber") && !nutrition.fiber) {
          const match = line.match(/(\d+(\.\d+)?)/);
          if (match) nutrition.fiber = parseFloat(match[1]);
        }
        if (line.includes("protein") && !nutrition.protein) {
          const match = line.match(/(\d+(\.\d+)?)/);
          if (match) nutrition.protein = parseFloat(match[1]);
        }
        if ((line.includes("fruit") || line.includes("vegetable") || line.includes("fvl")) && line.includes("%")) {
          const match = line.match(/(\d+(\.\d+)?)\s*%/);
          if (match) nutrition.fvlPercent = parseFloat(match[1]);
        }
      }

      return nutrition;
    }

    function getPoints(value, brackets) {
      for (let i = 0; i < brackets.length; i++) {
        if (value <= brackets[i]) return i;
      }
      return brackets.length;
    }

    function calculateNutriScore(n) {
      const energyPoints = getPoints(n.energy / 100, [335, 670, 1005, 1340, 1675, 2010, 2345, 2680, 3015, 3350]);
      const sugarPoints = getPoints(n.sugar, [4.5, 9, 13.5, 18, 22.5, 27, 31, 36, 40, 45]);
      const satFatPoints = getPoints(n.satFat, [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]);
      const sodiumPoints = getPoints(n.sodium, [90, 180, 270, 360, 450, 540, 630, 720, 810, 900]);
      const fiberPoints = getPoints(n.fiber, [0.9, 1.9, 2.8, 3.7, 4.7]);
      const proteinPoints = getPoints(n.protein, [1.6, 3.2, 4.8, 6.4, 8.0]);
      const fvlPoints = getPoints(n.fvlPercent || 0, [40, 60, 80]) + 1; // 0â€“5 pts

      const A = energyPoints + sugarPoints + satFatPoints + sodiumPoints;
      const C = fiberPoints + fvlPoints + ((A < 11 || fvlPoints === 5) ? proteinPoints : 0);
      const score = A - C;

      let grade = "?";
      if (score <= -1) grade = "A";
      else if (score <= 2) grade = "B";
      else if (score <= 10) grade = "C";
      else if (score <= 18) grade = "D";
      else grade = "E";

      return {
        grade,
        breakdown: { A, C, energyPoints, sugarPoints, satFatPoints, sodiumPoints, fiberPoints, proteinPoints, fvlPoints, finalScore: score }
      };
    }

    document.getElementById("upload").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const output = document.getElementById("output");
      output.textContent = "Processing...";

      const text = await extractTextFromImage(file);
      const data = parseNutritionText(text);
      const score = calculateNutriScore(data);

      output.textContent =
        `ðŸŸ¢ Nutri-Score: ${score.grade}\n\n` +
        `Score Breakdown:\n` +
        `Energy Points: ${score.breakdown.energyPoints}\n` +
        `Sugar Points: ${score.breakdown.sugarPoints}\n` +
        `Sat. Fat Points: ${score.breakdown.satFatPoints}\n` +
        `Sodium Points: ${score.breakdown.sodiumPoints}\n` +
        `â†’ A Total: ${score.breakdown.A}\n\n` +
        `Fiber Points: ${score.breakdown.fiberPoints}\n` +
        `Protein Points: ${score.breakdown.proteinPoints} ${score.breakdown.A >= 11 && score.breakdown.fvlPoints < 5 ? '(ignored)' : ''}\n` +
        `Fruits/Veg Points: ${score.breakdown.fvlPoints}\n` +
        `â†’ C Total: ${score.breakdown.C}\n\n` +
        `Final Score: ${score.breakdown.finalScore}`;
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</body>
</html>
