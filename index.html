<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NutriScanner with EU Nutri-Score</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      color: #2c3e50;
    }
    video, canvas, img {
      max-width: 100%;
    }
    #output {
      margin-top: 1em;
      white-space: pre-wrap;
      background: #fff;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .grade {
      font-size: 2em;
      font-weight: bold;
      padding: 0.2em 0.5em;
      border-radius: 8px;
      color: white;
    }
    .grade.A { background: #009966; }
    .grade.B { background: #99cc00; }
    .grade.C { background: #ffcc00; }
    .grade.D { background: #ff9933; }
    .grade.E { background: #cc0033; }
  </style>
</head>
<body>
  <h1>NutriScanner (EU Nutri-Score)</h1>

  <input type="file" accept="image/*" id="imageInput">
  <br><br>
  <img id="preview" style="display:none;">
  <div id="output">Scan an image with nutrition info to begin...</div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script>
    const input = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');

    input.addEventListener('change', async () => {
      const file = input.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.style.display = 'block';
      output.textContent = 'Extracting text...';

      const result = await Tesseract.recognize(url, 'eng');
      const text = result.data.text;
      output.textContent = text + "\n\nExtracting nutrition values...";

      const values = extractNutrition(text);
      const score = calculateNutriScore(values);

      output.textContent = `Extracted Values:\n${JSON.stringify(values, null, 2)}\n\nNutri-Score: `;

      const gradeSpan = document.createElement('span');
      gradeSpan.className = `grade ${score.grade}`;
      gradeSpan.textContent = score.grade;
      output.appendChild(gradeSpan);
    });

    function extractNutrition(text) {
      const lines = text.split(/\n|,/).map(l => l.toLowerCase());
      const get = (key) => {
        const line = lines.find(l => l.includes(key));
        if (!line) return null;
        const match = line.match(/([0-9]+([.,][0-9]+)*)/);
        return match ? parseFloat(match[1].replace(',', '.')) : null;
      };
      return {
        energy: get('energy') || 0, // in kJ
        sugars: get('sugar') || 0,
        satFat: get('satur') || 0,
        sodium: get('salt') ? (get('salt') * 400) : 0, // salt (g) to sodium (mg)
        fiber: get('fiber') || 0,
        protein: get('protein') || 0,
        fruitsPercent: get('fruit') || 0
      };
    }

    function calculateNutriScore(n) {
      let score = 0;
      // Negative points
      score += getPoints(n.energy, [335, 670, 1005, 1340, 1675, 2010, 2345, 2680, 3015, 3350]);
      score += getPoints(n.sugars, [4.5, 9, 13.5, 18, 22.5, 27, 31, 36, 40, 45]);
      score += getPoints(n.satFat, [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]);
      score += getPoints(n.sodium, [90, 180, 270, 360, 450, 540, 630, 720, 810, 900]);

      let positive = 0;
      positive += getReversePoints(n.fiber, [0.9, 1.9, 2.8, 3.7, 4.7]);
      positive += getReversePoints(n.protein, [1.6, 3.2, 4.8, 6.4, 8]);
      positive += n.fruitsPercent >= 80 ? 5 : n.fruitsPercent >= 60 ? 2 : n.fruitsPercent >= 40 ? 1 : 0;

      let finalScore = score - positive;
      let grade = 'E';
      if (finalScore <= -1) grade = 'A';
      else if (finalScore <= 2) grade = 'B';
      else if (finalScore <= 10) grade = 'C';
      else if (finalScore <= 18) grade = 'D';

      return { score: finalScore, grade };
    }

    function getPoints(value, thresholds) {
      for (let i = thresholds.length - 1; i >= 0; i--) {
        if (value > thresholds[i]) return i + 1;
      }
      return 0;
    }

    function getReversePoints(value, thresholds) {
      for (let i = thresholds.length - 1; i >= 0; i--) {
        if (value >= thresholds[i]) return i + 1;
      }
      return 0;
    }
  </script>
</body>
</html>
