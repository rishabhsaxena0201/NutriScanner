// script.js

let stream;
let usingBackCamera = true;

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const statusDiv = document.getElementById('status');
const ocrTextPre = document.getElementById('ocrText');
const nutritionDataPre = document.getElementById('nutritionData');
const nutriScoreDiv = document.getElementById('nutriScore');

// Start camera with constraints
async function startCamera() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
  const constraints = {
    video: {
      facingMode: usingBackCamera ? { exact: 'environment' } : 'user',
      focusMode: 'continuous',
      width: { ideal: 1280 },
      height: { ideal: 720 }
    },
    audio: false
  };

  try {
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
  } catch (err) {
    console.error('Camera error:', err);
    statusDiv.textContent = 'Camera access failed.';
  }
}

// Switch camera
function switchCamera() {
  usingBackCamera = !usingBackCamera;
  startCamera();
}

document.getElementById('startCamera').addEventListener('click', startCamera);
document.getElementById('switchCamera').addEventListener('click', switchCamera);
document.getElementById('capture').addEventListener('click', async () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const imageDataURL = canvas.toDataURL('image/png');
  await handleImage(imageDataURL);
});

document.getElementById('upload').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async () => await handleImage(reader.result);
  reader.readAsDataURL(file);
});

async function handleImage(dataUrl) {
  statusDiv.textContent = 'Processing image...';
  const worker = await Tesseract.createWorker('eng');
  const { data: { text } } = await worker.recognize(dataUrl);
  await worker.terminate();
  statusDiv.textContent = 'Text extracted.';
  ocrTextPre.textContent = text;

  const nutrition = extractNutritionData(text);
  nutritionDataPre.textContent = JSON.stringify(nutrition, null, 2);

  const nutriScore = calculateNutriScore(nutrition);
  nutriScoreDiv.innerHTML = nutriScore.breakdownHTML;
}

function extractNutritionData(text) {
  const lower = text.toLowerCase();
  const getVal = (label) => {
    const regex = new RegExp(`${label}[^\d]{0,10}(\d+(\.\d+)?)`, 'i');
    const match = lower.match(regex);
    return match ? parseFloat(match[1]) : null;
  };
  return {
    energy: getVal('energy'),
    sugar: getVal('sugar'),
    saturatedFat: getVal('saturated fat'),
    sodium: getVal('sodium') || getVal('salt') ? (getVal('salt') * 400) : null,
    fiber: getVal('fiber'),
    protein: getVal('protein'),
    fruitVeg: getVal('fruit') || getVal('vegetable')
  };
}

function calculateNutriScore(data) {
  const { energy = 0, sugar = 0, saturatedFat = 0, sodium = 0, fiber = 0, protein = 0, fruitVeg = 0 } = data;

  const points = {
    energy: energy > 0 ? Math.min(Math.floor(energy / 335), 10) : 0,
    sugar: sugar > 0 ? Math.min(Math.floor(sugar / 4.5), 10) : 0,
    saturatedFat: saturatedFat > 0 ? Math.min(Math.floor(saturatedFat / 1), 10) : 0,
    sodium: sodium > 0 ? Math.min(Math.floor(sodium / 90), 10) : 0,
    fiber: fiber > 0 ? Math.min(Math.floor(fiber / 0.9), 5) : 0,
    protein: protein > 0 ? Math.min(Math.floor(protein / 1.6), 5) : 0,
    fruitVeg: fruitVeg > 80 ? 5 : fruitVeg > 60 ? 2 : fruitVeg > 40 ? 1 : 0
  };

  const negative = points.energy + points.sugar + points.saturatedFat + points.sodium;
  const positive = points.fiber + points.protein + points.fruitVeg;

  const total = negative - positive;
  let grade = 'A';
  if (total > 18) grade = 'E';
  else if (total > 10) grade = 'D';
  else if (total > 2) grade = 'C';
  else if (total > 0) grade = 'B';

  return {
    score: total,
    grade,
    breakdownHTML: `
      <strong>Nutri-Score: ${grade}</strong><br>
      <ul>
        <li>Energy: ${points.energy} pts</li>
        <li>Sugar: ${points.sugar} pts</li>
        <li>Saturated Fat: ${points.saturatedFat} pts</li>
        <li>Sodium: ${points.sodium} pts</li>
        <li>Fiber: ${points.fiber} pts</li>
        <li>Protein: ${points.protein} pts</li>
        <li>Fruit/Veg %: ${points.fruitVeg} pts</li>
        <li><strong>Total Score: ${total}</strong></li>
      </ul>`
  };
}
