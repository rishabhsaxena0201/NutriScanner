<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NutriScanner</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 1rem;
      padding: 0;
    }
    textarea, pre {
      width: 100%;
      font-family: monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .block {
      margin: 1rem 0;
    }
    button {
      margin: 0.25rem;
    }
  </style>
</head>
<body>
  <h2>NutriScanner</h2>
  <input type="file" accept="image/*" id="fileInput" />
  <div class="block"><button onclick="handleFile()">Scan</button></div>

  <div class="block">
    <h3>OCR Text</h3>
    <pre id="ocrText"></pre>
  </div>

  <div class="block">
    <h3>Extracted Nutrition</h3>
    <pre id="nutritionData"></pre>
  </div>

  <div class="block">
    <h3>Nutri-Score</h3>
    <p id="nutriScore"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const ocrText = document.getElementById('ocrText');
    const nutritionData = document.getElementById('nutritionData');
    const nutriScore = document.getElementById('nutriScore');

    function estimateFromIngredients(text) {
      const lower = text.toLowerCase();
      const data = {
        energy: null,
        sugar: null,
        satFat: null,
        sodium: null,
        fiber: null,
        fruitPercent: null,
        protein: null
      };

      const lines = lower.split('\n');

      for (const line of lines) {
        const l = line.trim();

        // Try matching numeric nutrients
        if (/energy|kcal/.test(l)) {
          const match = l.match(/(\d{2,4})\s?kcal/);
          if (match) data.energy = parseInt(match[1]);
        }
        if (/sugar/.test(l)) {
          const match = l.match(/(\d+(\.\d+)?)\s?g/);
          if (match) data.sugar = parseFloat(match[1]);
        }
        if (/saturated|sat fat/.test(l)) {
          const match = l.match(/(\d+(\.\d+)?)\s?g/);
          if (match) data.satFat = parseFloat(match[1]);
        }
        if (/sodium/.test(l)) {
          const match = l.match(/(\d{2,4})\s?mg/);
          if (match) data.sodium = parseInt(match[1]);
        }
        if (/fiber/.test(l)) {
          const match = l.match(/(\d+(\.\d+)?)\s?g/);
          if (match) data.fiber = parseFloat(match[1]);
        }
        if (/protein/.test(l)) {
          const match = l.match(/(\d+(\.\d+)?)\s?g/);
          if (match) data.protein = parseFloat(match[1]);
        }

        // Estimations from keywords
        if (/fruit|fruit puree|juice/.test(l)) data.fruitPercent = 40;
        if (/hazelnut|almond|nut|cocoa|vegetable oil/.test(l)) {
          if (data.satFat == null) data.satFat = 10;
          if (data.energy == null) data.energy = 2000;
        }
        if (/milk|whey/.test(l)) {
          if (data.protein == null) data.protein = 6;
        }
      }
      return data;
    }

    function calcNutriScore(nutrition) {
      const { energy, sugar, satFat, sodium, fiber, fruitPercent, protein } = nutrition;
      if (
        energy == null || sugar == null || satFat == null ||
        sodium == null || fiber == null || fruitPercent == null || protein == null
      ) return 'Could not calculate Nutri-Score.';

      let score = 0;
      score += energy / 335;           // A1: energy points
      score += sugar / 4.5;            // A2: sugar points
      score += satFat / 1;             // A3: sat fat points
      score += sodium / 90;            // A4: sodium points

      score -= fiber * 1.5;            // C1: fiber points
      score -= fruitPercent / 8;       // C2: fruit %
      score -= protein / 1.6;          // C3: protein

      let final = Math.round(score);
      if (final <= -1) return 'A';
      if (final <= 2) return 'B';
      if (final <= 10) return 'C';
      if (final <= 18) return 'D';
      return 'E';
    }

    async function handleFile() {
      const file = fileInput.files[0];
      if (!file) return;

      const result = await Tesseract.recognize(file, 'eng');
      const text = result.data.text;
      ocrText.textContent = text.trim();

      const parsed = estimateFromIngredients(text);
      nutritionData.textContent = JSON.stringify(parsed, null, 2);

      nutriScore.textContent = calcNutriScore(parsed);
    }
  </script>
</body>
</html>
