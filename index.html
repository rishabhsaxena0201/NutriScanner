<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NutriScanner</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 1em;
      padding: 0;
      background: #f9f9f9;
      color: #222;
    }
    h1 {
      text-align: center;
    }
    button {
      padding: 0.6em 1em;
      margin: 0.3em;
      font-size: 1em;
    }
    #preview {
      max-width: 100%;
      margin-top: 1em;
      border: 1px solid #ccc;
    }
    pre {
      background: #eee;
      padding: 0.5em;
      white-space: pre-wrap;
    }
    .section {
      margin-top: 1.5em;
    }
  </style>
</head>
<body>
  <h1>NutriScanner</h1>

  <input type="file" accept="image/*" capture="environment" id="cameraInput" style="display:none;">
  <input type="file" accept="image/*" id="uploadInput" style="display:none;">

  <div>
    <button onclick="document.getElementById('cameraInput').click()">üì∑ Take Photo</button>
    <button onclick="document.getElementById('uploadInput').click()">üìÅ Upload Image</button>
  </div>

  <img id="preview" />

  <div class="section">
    <h2>Extracted Text</h2>
    <pre id="ocrText">Waiting for input...</pre>
  </div>

  <div class="section">
    <h2>Nutri-Score</h2>
    <div id="nutriScore">‚Äì</div>
    <pre id="scoreBreakdown"></pre>
  </div>

  <script>
    const ocrText = document.getElementById('ocrText');
    const nutriScore = document.getElementById('nutriScore');
    const scoreBreakdown = document.getElementById('scoreBreakdown');
    const imgPreview = document.getElementById('preview');

    document.getElementById('cameraInput').addEventListener('change', handleImage);
    document.getElementById('uploadInput').addEventListener('change', handleImage);

    async function handleImage(event) {
      const file = event.target.files[0];
      if (!file) return;

      ocrText.textContent = 'Scanning image...';
      nutriScore.textContent = '';
      scoreBreakdown.textContent = '';

      imgPreview.src = URL.createObjectURL(file);

      const { data: { text } } = await Tesseract.recognize(file, 'eng');
      ocrText.textContent = text;

      const nutrition = parseNutrition(text);
      const { score, grade, breakdown } = computeNutriScore(nutrition);

      nutriScore.innerHTML = `<strong>Nutri-Score: ${grade}</strong> (score = ${score})`;
      scoreBreakdown.textContent = breakdown;
    }

    function parseNutrition(text) {
      const lines = text.toLowerCase();
      const match = (label) => {
        const re = new RegExp(`${label}\\D*(\\d+[.,]?\\d*)`, 'i');
        const m = lines.match(re);
        return m ? parseFloat(m[1].replace(',', '.')) : null;
      };

      return {
        energyKJ: match('energy') || match('kj'),
        sugar: match('sugar'),
        saturatedFat: match('saturated') || match('sat fat'),
        sodium: match('sodium') || (match('salt') ? match('salt') * 400 : null),
        fiber: match('fiber'),
        protein: match('protein'),
        fruitPercent: match('fruit') || match('vegetable') || match('fruit & veg')
      };
    }

    function computeNutriScore(n) {
      let score = 0;
      let breakdown = '';

      // A points (negative)
      const energyPoints = n.energyKJ ? Math.min(Math.floor(n.energyKJ / 335), 10) : 0;
      const sugarPoints = n.sugar ? (n.sugar <= 4.5 ? 0 : n.sugar <= 9 ? 1 : n.sugar <= 13.5 ? 2 : n.sugar <= 18 ? 3 : 4) : 0;
      const satFatPoints = n.saturatedFat ? (n.saturatedFat <= 1 ? 0 : n.saturatedFat <= 2 ? 1 : n.saturatedFat <= 3 ? 2 : n.saturatedFat <= 4 ? 3 : 4) : 0;
      const sodiumPoints = n.sodium ? (n.sodium <= 90 ? 0 : n.sodium <= 180 ? 1 : n.sodium <= 270 ? 2 : n.sodium <= 360 ? 3 : 4) : 0;

      const aPoints = energyPoints + sugarPoints + satFatPoints + sodiumPoints;

      // C points (positive)
      const fiberPoints = n.fiber ? (n.fiber <= 0.9 ? 0 : n.fiber <= 1.9 ? 1 : n.fiber <= 2.8 ? 2 : n.fiber <= 3.7 ? 3 : 4) : 0;
      const proteinPoints = n.protein ? (n.protein <= 1.6 ? 0 : n.protein <= 3.2 ? 1 : n.protein <= 4.8 ? 2 : n.protein <= 6.4 ? 3 : 4) : 0;
      const fruitPoints = n.fruitPercent ? (n.fruitPercent < 40 ? 0 : n.fruitPercent < 60 ? 1 : n.fruitPercent < 80 ? 2 : 5) : 0;

      const cPoints = fiberPoints + proteinPoints + fruitPoints;

      // Final score logic
      score = aPoints - cPoints;

      // Grade
      let grade = 'E';
      if (score <= -1) grade = 'A';
      else if (score <= 2) grade = 'B';
      else if (score <= 10) grade = 'C';
      else if (score <= 18) grade = 'D';

      breakdown = `
Energy Points: ${energyPoints}
Sugar Points: ${sugarPoints}
Saturated Fat Points: ${satFatPoints}
Sodium Points: ${sodiumPoints}
Fiber Points: ${fiberPoints}
Protein Points: ${proteinPoints}
Fruit/Veg % Points: ${fruitPoints}
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
Final Nutri-Score = ${score}
Grade: ${grade}
      `.trim();

      return { score, grade, breakdown };
    }
  </script>
</body>
</html>
