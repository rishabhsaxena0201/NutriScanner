<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NutriScanner</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      font-size: 1.8rem;
    }
    button, input {
      margin: 0.5rem 0;
      padding: 0.5rem;
      font-size: 1rem;
    }
    pre {
      background: #f6f6f6;
      padding: 0.5rem;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>

  <h1>NutriScanner</h1>

  <input type="file" id="fileInput" accept="image/*">
  <br>
  <button id="scanButton">Scan</button>

  <h3>OCR Progress & Text</h3>
  <pre id="ocrOutput">Waiting...</pre>

  <h3>Extracted Nutrition</h3>
  <pre id="nutritionOutput">-</pre>

  <h3>Nutri-Score</h3>
  <pre id="nutriScoreOutput">-</pre>

  <script>
    const fileInput = document.getElementById('fileInput');
    const scanButton = document.getElementById('scanButton');
    const ocrOutput = document.getElementById('ocrOutput');
    const nutritionOutput = document.getElementById('nutritionOutput');
    const nutriScoreOutput = document.getElementById('nutriScoreOutput');

    scanButton.onclick = async () => {
      const file = fileInput.files[0];
      if (!file) {
        ocrOutput.textContent = 'No image selected.';
        return;
      }

      ocrOutput.textContent = 'Reading image...';
      try {
        const { data: { text } } = await Tesseract.recognize(file, 'eng', {
          logger: m => {
            ocrOutput.textContent = `Status: ${m.status}, Progress: ${Math.round(m.progress * 100)}%`;
          }
        });

        ocrOutput.textContent = 'OCR Text:\n' + text;

        const lowerText = text.toLowerCase();
        const parsed = {
          energy_kj: findValue(lowerText, /(energy|energi)[^\d]{0,10}(\d{2,5})\s?k?j/),
          sugars_g: findValue(lowerText, /sugars?[^\d]{0,10}(\d{1,3})\s?g/),
          saturated_fat_g: findValue(lowerText, /(sat\.? fat|saturated)[^\d]{0,10}(\d{1,2})\s?g/),
          sodium_mg: findValue(lowerText, /(sodium|salt)[^\d]{0,10}(\d{1,4})\s?(mg|g)/, true),
          fiber_g: findValue(lowerText, /fibre|fiber[^\d]{0,10}(\d{1,2})\s?g/),
          fruits_percent: findValue(lowerText, /fruit[s]?[^\d]{0,10}(\d{1,3})\s?%/),
          protein_g: findValue(lowerText, /protein[^\d]{0,10}(\d{1,2})\s?g/)
        };

        nutritionOutput.textContent = JSON.stringify(parsed, null, 2);
        nutriScoreOutput.textContent = 'Nutri-Score: ' + getNutriScore(parsed);

      } catch (err) {
        console.error(err);
        ocrOutput.textContent = 'OCR failed: ' + err.message;
      }
    };

    function findValue(text, pattern, convertToMg = false) {
      const match = text.match(pattern);
      if (!match) return null;
      let val = parseFloat(match[2]);
      if (convertToMg && match[3] === 'g') val *= 1000;
      return val;
    }

    function getNutriScore(n) {
      if (!n.energy_kj) return 'N/A';
      const negative = (n.energy_kj / 335) + (n.sugars_g || 0) + (n.saturated_fat_g || 0) + ((n.sodium_mg || 0) / 90);
      const positive = (n.fiber_g || 0) * 1.5 + ((n.fruits_percent || 0) / 10) + (n.protein_g || 0);
      const score = negative - positive;

      if (score <= -1) return 'A';
      if (score <= 2) return 'B';
      if (score <= 10) return 'C';
      if (score <= 18) return 'D';
      return 'E';
    }
  </script>

</body>
</html>
