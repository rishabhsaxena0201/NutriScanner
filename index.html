<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NutriScanner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #2d3748;
    }
    #upload {
      margin-top: 20px;
    }
    #image-preview {
      max-width: 90%;
      margin-top: 20px;
    }
    #results {
      background: #ffffff;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      text-align: left;
      display: inline-block;
    }
    .nutriscore {
      font-size: 24px;
      font-weight: bold;
      padding: 10px 15px;
      border-radius: 6px;
      color: white;
      display: inline-block;
      margin-top: 10px;
    }
    .A { background-color: #008000; }
    .B { background-color: #a4c400; }
    .C { background-color: #ffc107; }
    .D { background-color: #ff5722; }
    .E { background-color: #d32f2f; }
  </style>
</head>
<body>
  <h1>NutriScanner</h1>
  <input type="file" accept="image/*" id="upload" />
  <img id="image-preview" src="#" style="display:none;" />
  <div id="results"></div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script>
    const upload = document.getElementById('upload');
    const imagePreview = document.getElementById('image-preview');
    const results = document.getElementById('results');

    upload.addEventListener('change', async function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
        results.innerHTML = 'Scanning...';
        extractText(e.target.result);
      };
      reader.readAsDataURL(file);
    });

    function extractText(imgData) {
      Tesseract.recognize(imgData, 'eng').then(({ data: { text } }) => {
        const lines = text.split('\n').map(l => l.trim());
        let data = {
          energy: null,
          sugars: null,
          fat: null,
          satFat: null,
          salt: null,
          fiber: null,
          protein: null,
          fruitVeg: null
        };

        lines.forEach(line => {
          const lc = line.toLowerCase();

          if (lc.includes('energy')) {
            const match = line.match(/(\d+)\s?k?j/);
            if (match) data.energy = parseInt(match[1]);
          }
          if (lc.includes('sugar')) {
            const match = line.match(/(\d+(\.\d+)?)\s?g/);
            if (match) data.sugars = parseFloat(match[1]);
          }
          if (lc.includes('saturat')) {
            const match = line.match(/(\d+(\.\d+)?)\s?g/);
            if (match) data.satFat = parseFloat(match[1]);
          }
          if (lc.includes('salt') || lc.includes('sodium')) {
            const match = line.match(/(\d+(\.\d+)?)\s?g/);
            if (match) data.salt = parseFloat(match[1]) * 1000; // g to mg
          }
          if (lc.includes('fiber')) {
            const match = line.match(/(\d+(\.\d+)?)\s?g/);
            if (match) data.fiber = parseFloat(match[1]);
          }
          if (lc.includes('protein')) {
            const match = line.match(/(\d+(\.\d+)?)\s?g/);
            if (match) data.protein = parseFloat(match[1]);
          }
          if (lc.includes('%') && lc.includes('fruit')) {
            const match = line.match(/(\d+(\.\d+)?)\s?%/);
            if (match) data.fruitVeg = parseFloat(match[1]);
          }
        });

        const grade = calculateNutriScore(data);
        displayResults(data, grade);
      });
    }

    function calculateNutriScore(d) {
      if (!d.energy || !d.sugars || !d.satFat || !d.salt) return '?';

      const neg = scoreEnergy(d.energy) + scoreSugars(d.sugars) +
                  scoreSatFat(d.satFat) + scoreSalt(d.salt);
      const pos = scoreFiber(d.fiber || 0) + scoreProtein(d.protein || 0) +
                  scoreFruitVeg(d.fruitVeg || 0);

      const final = neg - pos;

      if (final <= -1) return 'A';
      if (final <= 2) return 'B';
      if (final <= 10) return 'C';
      if (final <= 18) return 'D';
      return 'E';
    }

    const scoreEnergy = kJ => kJ >= 3350 ? 10 : Math.floor(kJ / 335);
    const scoreSugars = g => g >= 45 ? 10 : Math.floor(g / 4.5);
    const scoreSatFat = g => g >= 10 ? 10 : Math.floor(g);
    const scoreSalt = mg => mg >= 900 ? 10 : Math.floor(mg / 90);
    const scoreFiber = g => g >= 4.7 ? 5 : Math.floor(g);
    const scoreProtein = g => g >= 8 ? 5 : Math.floor(g / 1.6);
    const scoreFruitVeg = p => p >= 80 ? 5 : p >= 60 ? 2 : p >= 40 ? 1 : 0;

    function displayResults(data, grade) {
      results.innerHTML = `
        <h3>Extracted Nutrients:</h3>
        <ul>
          <li><strong>Energy:</strong> ${data.energy || '—'} kJ</li>
          <li><strong>Sugars:</strong> ${data.sugars || '—'} g</li>
          <li><strong>Saturated Fat:</strong> ${data.satFat || '—'} g</li>
          <li><strong>Salt:</strong> ${data.salt || '—'} mg</li>
          <li><strong>Fiber:</strong> ${data.fiber || '—'} g</li>
          <li><strong>Protein:</strong> ${data.protein || '—'} g</li>
          <li><strong>Fruit/Veg %:</strong> ${data.fruitVeg || '—'}%</li>
        </ul>
        <div class="nutriscore ${grade}">
          Nutri-Score: ${grade}
        </div>
      `;
    }
  </script>
</body>
</html>
