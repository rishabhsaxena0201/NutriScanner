// Updated script.js with better OCR parsing and Nutri-Score breakdown

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const fileInput = document.getElementById("fileInput");
const startCamera = document.getElementById("startCamera");
const switchCameraButton = document.getElementById("switchCameraButton");
const captureButton = document.getElementById("captureButton");
const statusDiv = document.getElementById("status");
const ocrText = document.getElementById("ocrText");
const nutritionData = document.getElementById("nutritionData");
const nutriScoreDiv = document.getElementById("nutriScore");

let useFrontCamera = false;
let currentStream;

startCamera.onclick = async () => {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
  }

  const constraints = {
    video: {
      facingMode: useFrontCamera ? "user" : "environment"
    }
  };

  currentStream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject = currentStream;
};

switchCameraButton.onclick = () => {
  useFrontCamera = !useFrontCamera;
  startCamera.click();
};

captureButton.onclick = () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  const image = canvas.toDataURL("image/png");
  processImage(image);
};

fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = () => processImage(reader.result);
    reader.readAsDataURL(file);
  }
});

async function processImage(imageDataUrl) {
  statusDiv.textContent = "Processing image...";
  const result = await Tesseract.recognize(imageDataUrl, "eng");
  const rawText = result.data.text;
  ocrText.textContent = rawText;
  const parsed = parseNutritionData(rawText);
  nutritionData.textContent = JSON.stringify(parsed, null, 2);
  const score = calculateNutriScore(parsed);
  nutriScoreDiv.innerHTML = score.html;
  statusDiv.textContent = "Done.";
}

function parseNutritionData(text) {
  const result = {};
  const lines = text.split(/\n|\r|;/).map(l => l.trim().toLowerCase());
  const findValue = (regex) => {
    for (const line of lines) {
      const match = line.match(regex);
      if (match) return parseFloat(match[1].replace(",", "."));
    }
    return null;
  };
  result.energy = findValue(/energy.*?(\d+(\.\d+)?)/i);
  result.sugars = findValue(/sugars?.*?(\d+(\.\d+)?)/i);
  result.satFat = findValue(/saturated.*?(\d+(\.\d+)?)/i);
  result.sodium = findValue(/sodium.*?(\d+(\.\d+)?)/i) || findValue(/salt.*?(\d+(\.\d+)?)/i);
  result.fiber = findValue(/fiber.*?(\d+(\.\d+)?)/i);
  result.protein = findValue(/protein.*?(\d+(\.\d+)?)/i);
  result.fruits = findValue(/fruit[s%]?[\s\-:]*?(\d+(\.\d+)?)/i);
  return result;
}

function calculateNutriScore(nutrition) {
  let points = { energy: 0, sugars: 0, satFat: 0, sodium: 0, fiber: 0, protein: 0, fruits: 0 };

  if (nutrition.energy !== null)
    points.energy = Math.min(10, Math.floor(nutrition.energy / 335));
  if (nutrition.sugars !== null)
    points.sugars = Math.min(10, Math.floor(nutrition.sugars / 4.5));
  if (nutrition.satFat !== null)
    points.satFat = Math.min(10, Math.floor(nutrition.satFat / 1));
  if (nutrition.sodium !== null)
    points.sodium = Math.min(10, Math.floor((nutrition.sodium * 1000) / 90));

  if (nutrition.fiber !== null)
    points.fiber = Math.min(5, Math.floor(nutrition.fiber / 0.9));
  if (nutrition.protein !== null)
    points.protein = Math.min(5, Math.floor(nutrition.protein / 1.6));
  if (nutrition.fruits !== null)
    points.fruits = nutrition.fruits >= 80 ? 5 : nutrition.fruits >= 60 ? 2 : nutrition.fruits >= 40 ? 1 : 0;

  const negative = points.energy + points.sugars + points.satFat + points.sodium;
  const positive = points.fiber + points.protein + points.fruits;

  const finalScore = negative - positive;
  let grade = "E";
  if (finalScore <= -1) grade = "A";
  else if (finalScore <= 2) grade = "B";
  else if (finalScore <= 10) grade = "C";
  else if (finalScore <= 18) grade = "D";

  return {
    score: finalScore,
    html: `
      <h3>Nutri-Score: <span>${grade}</span></h3>
      <pre>
Energy Points: ${points.energy}
Sugar Points: ${points.sugars}
Saturated Fat Points: ${points.satFat}
Sodium Points: ${points.sodium}
Fiber Points: ${points.fiber}
Protein Points: ${points.protein}
Fruits/Vegetables Points: ${points.fruits}

Final Score: ${finalScore}
</pre>`
  };
}
